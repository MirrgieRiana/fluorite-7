#!/usr/bin/env bash

usage() {
	echo "Usage $0 [-j] CODE" >&2
	exit 1
}

output_json=0

if [ "$1" = "-j" ]
then
  shift
  output_json=1
fi

(($# > 0)) || usage
exec=$1
shift

(($# > 0)) && usage

#

cd "$(cd "$(dirname "$0")"; pwd)"

if [ ! -f ./fluorite-7.js ]
then
	./compile.bash || exit 2
fi

export exec
export output_json
node - << 'END'
var source = process.env.exec;
var parser = require("./fluorite-7.js");
var result = parser.parse(source);

var env = new result.fl7c.Environment();
result.loadAliases(env);

var code = result.node.getCode(env);

var util = result.fl7.util;
var constants = env.getConstants();
var stream = util.toStreamer(eval(code)).start();

if (process.env.output_json !== "0") {
  while (true) {
    var next = stream.next();
    if (next === undefined) break;
    console.log(JSON.stringify(next));
  }
} else {
  while (true) {
    var next = stream.next();
    if (next === undefined) break;
    console.log(util.toString(next));
  }
}

END
